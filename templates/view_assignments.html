{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="text-center">
        <h1 class="mb-3">{% block title %} <u>Welcome to the Assignment Manager! </u> {% endblock %}</h1>
        <h2> This application is designed to help you stay organized and balance your tasks with ease! </h2>
    </div>
</div>

<div class="text-center mb-4">
    <h2 style="color:#e5a6a1;"> <em>Upcoming Events This Week:</em></h2>
</div>
<div class="mb-5" style="font-size: 17px;">
    {% if assignments %}
    <ul class="list-group">
        {% for assignment in assignments %}
        <li class="list-group-item">{{ assignment.name }}: {{assignment.get_due_str() }}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-left"> No assignments this week!</p>
    {% endif %}
</div>

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1>{% block text %} Your Assignments {% endblock %}</h1>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="alert-container">
    {% for category, message in messages %}
    <div class="alert alert-{{category}} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div style="display: flex; justify-content: left; font-size: 17px;">
    <table class="table table-striped table-bordered">
        <tr>
            <th style="color: #a57101; border-bottom: 1px solid black;"> Name
            </th>
            <th style="color: #a57101; border-bottom: 1px solid black;"> Due Date </th>
            <th style="color: #a57101; border-bottom: 1px solid black;"> Due Time </th>
            <th style="color: #a57101; border-bottom: 1px solid black;"> Actions </th>
        </tr>
        {% for assignment in assignments %}
        <tr>
            <td id="assignment_name">{{ assignment.name }}</td>
            <td>{{ assignment.due_date.strftime("%m/%d/%y") }}</td>
            <td>{{ assignment.due_time.strftime("%I:%M %p") }}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-primary" id="edit-btn"
                        style="font-size:large; background-color: #0e4bd9; border: none; color: white; border-radius: 5px;"
                        data-bs-toggle="modal" data-bs-target="#editModal" data-name="{{ assignment.name }}"
                        data-due-date="{{ assignment.due_date }}" data-due-time="{{ assignment.due_time }} ">
                        Edit
                    </button>

                    &nbsp;
                    <button class="btn btn-primary" id="delete-btn"
                        style="font-size: large; background-color: #e6151f; color: white; border: none; border-radius: 5px;"
                        data-bs-toggle="modal" data-bs-target="#deleteModal" data-name="{{ assignment.name }}">Remove
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>
<div class="mt-4">
    <a href="{{ url_for('add_assignment_page')}}">
        <button class="btn btn-light" style="background-color: #b99290; color: white"> + Add Assignment </button>
    </a>
</div>

<div class="modal fade" id="editModal">
    <div class="modal-dialog d-flex justify-content-center modal-dialog-centered">
        <div class="modal-content w-75">
            <div class="modal-header">
                <h5 class="modal-title"> Edit Assignment</h5>
                <button type="button" background-color: #e5a6a1; class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editForm">
                    <div class="form-floating mb-4">
                        <input type="text" id="modal_name" class="form-control" name="name" placeholder="Name here" />
                        <label class="form-label" for="modal_name"> Assignment Name </label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="date" id="modal_due_date" class="form-control" name="due_date" />
                        <label class="form-label" for="modal_due_date"> Due Date </label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="time" id="modal_due_time" class="form-control" name="due_time" />
                        <label class="form-label" for="modal_due_time"> Due Time </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal">
    <div class="modal-dialog d-flex justify-content-center modal-dialog-centered">
        <div class="modal-content w-75">
            <div class="modal-header">
                <h5 class="modal-title">Remove Assignment</h5>
                <button type="button" background-color: #e5a6a1; class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p>Are you sure? This is for real!</p>
                <button type="submit" id="modal-delete-btn" class="btn btn-danger">Remove</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('button[id^="edit-btn"]').click(function (e) {
            name = $(this).data('name');
            dueDate = $(this).data('due-date');
            dueTime = $(this).data('due-time');
            $('#modal_name').val(name);
            $('#modal_due_date').val(dueDate.split(" ")[0]);
            $('#modal_due_time').val(dueTime.split(" ")[1]);

            url = '/update_assignment/' + encodeURI(name);

        });

        $('#editForm').on('submit', function (e) {
            e.preventDefault();
            formData = {
                name: $("#modal_name").val(),
                due_date: $("#modal_due_date").val(),
                due_time: $("#modal_due_time").val(),
            };

            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                success: function (data) {
                    //alert("Assignment updated successfully!")
                    $('#editModal').modal('hide');
                    location.reload();
                },
                error: function () {
                    //alert("An error has occurred");
                    $('#editModal').modal('hide');
                }
            });
        });

        // just an ugly hack to "remember" the assignment name, used later below
        $('button[id^="delete-btn"]').click(function (e) {
            globalThis.assignment_to_delete = $(this).data('name');
        });

        $('button[id^="modal-delete-btn"]').click(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/remove_assignment/'+encodeURI(globalThis.assignment_to_delete),
                type: 'GET',
                success: function (data) {
                    $('#deleteModal').modal('hide');
                    location.reload();
                },
                error: function () {
                    $('#deleteModal').modal('hide');
                }
            });
            globalThis.assignment_to_delete = null;
        });
    });
</script>

{% endblock %}